id: test_ssh_connection
namespace: my_namespace

inputs:
  - id: machines
    type: MULTISELECT
    values:
      - ai-stack
      - infrastrcture
      - media-downloader
      - media-streamer
      - pi-hole
      - proxmox
      - remote-access

tasks:
  - id: global_var_machines
    type: io.kestra.plugin.core.kv.Get
    key: global_var_machines

  - id: ansible_setup
    type: io.kestra.plugin.core.flow.WorkingDirectory
    inputFiles:
      inventory.ini: |
        [hosts]
        {% for machine in inputs.machines %}
        {{ outputs.global_var_machines.value[machine]['url'] }}    ansible_user={{ outputs.global_var_machines.value[machine]['user'] }}
        {% endfor %}
      myplaybook.yaml: |
        ---
        - name: Test Connections
          hosts: hosts
          tasks:
            - name: Log successful connection
              debug:
                msg: SSH connection successful!

      id_rsa: "{{ secret('KESTRA_BASE64_PRIVATE_SSH_KEY') }}"

    tasks:
      - id: ansible_playbook
        type: io.kestra.plugin.ansible.cli.AnsibleCLI
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
          image: docker.io/cytopia/ansible:latest-tools
          user: "1000"
        env:
          "ANSIBLE_HOST_KEY_CHECKING": "False"
        commands:
          - ansible-playbook -i inventory.ini --key-file id_rsa myplaybook.yaml
